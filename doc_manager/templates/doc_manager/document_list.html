{% extends 'base.html' %}
{% load static %}
{% load rag_filters %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/doc_manager/document_list.css' %}">
{% endblock %}

{% block content %}
<div class="semantic-container">
    <h1 class="page-title">Semantic Search Engine</h1>

    {% if user.profile.is_searcher %}
        <!-- Search Form -->
        <form method="GET" action="{% url 'document_list' %}" class="search-form">
            <input type="text" name="q" placeholder="Ask a question about the documents..." 
                   class="form-control search-input" value="{{ search_query }}" autofocus>
            <button type="submit" class="btn btn-primary search-btn">
                <i class="fas fa-search me-2"></i>Search
            </button>
        </form>

        <!-- Search Results -->
        {% if rag_results_by_doc %}
            <h2 class="section-title mt-4">
                <i class="fas fa-brain me-2"></i>Semantic Search Results
            </h2>
            <p class="lead text-muted mb-4">
                Showing relevant passages for: "<strong>{{ search_query }}</strong>"
            </p>
            
            {% for doc_title, chunks in rag_results_by_doc.items %}
                <div class="card result-card mb-4 shadow">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <span>
                            <i class="fas fa-file-alt me-2"></i> 
                            <strong>{{ doc_title }}</strong>
                            <span class="badge bg-light text-primary ms-2">
                                {{ chunks|length }} result{{ chunks|length|pluralize }}
                            </span>
                        </span>
                    </div>
                    
                    <ul class="list-group list-group-flush">
                        {% for chunk in chunks %}
                            <li class="list-group-item">
                                <div class="chunk-metadata d-flex justify-content-between align-items-center flex-wrap">
                                    <div class="metadata-info d-flex flex-wrap align-items-center gap-3">
                                        <span>
                                            <i class="fas fa-file-alt me-1 text-primary"></i>
                                            <strong>Page:</strong> 
                                            <span class="badge bg-info text-white">
                                                {{ chunk.page }}
                                            </span>
                                        </span>
                                        <span>
                                            <i class="fas fa-tag me-1 text-secondary"></i>
                                            <strong>Type:</strong> 
                                            <span class="badge bg-light text-secondary">{{ chunk.type }}</span>
                                        </span>
                                        <span class="distance-indicator">
                                            <i class="fas fa-chart-line me-1"></i>
                                            <strong>Relevance:</strong> 
                                            {{ chunk.distance|format_distance }}
                                        </span>
                                    </div>
                                    
                                    <!-- Bottone View per ogni singolo chunk -->
                                    {% if chunk.document_id %}
                                    <div class="chunk-action mt-2 mt-md-0">
                                        <a href="{% url 'document_viewer' chunk.document_id %}?page={{ chunk.page }}" 
                                           class="btn btn-sm btn-outline-primary view-page-btn"
                                           title="Open document at page {{ chunk.page }}">
                                            <i class="fas fa-external-link-alt me-1"></i>
                                            View Page {{ chunk.page }}
                                        </a>
                                    </div>
                                    {% endif %}
                                </div>

                                <!-- Contenuto del Chunk Renderizzato -->
                                <div class="chunk-content">
                                    {{ chunk.content|render_rag_content:chunk.type }}
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            {% endfor %}
            
            <!-- Info Box -->
            <div class="alert alert-info mt-4">
                <i class="fas fa-lightbulb me-2"></i>
                <strong>Tip:</strong> Click on "View Page" button to open the PDF at the exact location of each result.
            </div>
            
        {% elif search_query %}
            <div class="alert alert-warning mt-4">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Semantic search executed, but no relevant content was found for "<strong>{{ search_query }}</strong>".
                <br>
                <small class="mt-2 d-block">Try rephrasing your query or using different keywords.</small>
            </div>
        {% endif %}

        {% if rag_error %}
            <div class="alert alert-danger mt-4">
                <i class="fas fa-exclamation-circle me-2"></i>
                <strong>RAG Search Error:</strong> {{ rag_error }}
            </div>
        {% endif %}

        <hr class="divider">

        <!-- Document List -->
        {% if documents %}
            <h2 class="section-title">
                <i class="fas fa-folder-open me-2"></i>Available Documents 
                <span class="badge bg-primary">{{ documents.count }}</span>
            </h2>
            <p class="text-muted small mb-3">Documents processed and available for semantic search.</p>

            <div class="doc-list">
                {% for doc in documents %}
                    <div class="doc-card shadow-sm">
                        <div class="doc-header">
                            <div class="d-flex justify-content-between align-items-start w-100">
                                <div>
                                    <strong class="d-block mb-1">{{ doc.title }}</strong>
                                    <small class="text-muted">
                                        <i class="fas fa-user me-1"></i>{{ doc.uploader.username }} â€¢ 
                                        <i class="fas fa-calendar me-1"></i>{{ doc.uploaded_at|date:"M d, Y" }}
                                    </small>
                                </div>
                                <div class="d-flex gap-2">
                                    <a href="{% url 'document_viewer' doc.pk %}" 
                                       class="btn btn-outline-primary btn-sm">
                                        <i class="fas fa-eye me-1"></i>View
                                    </a>
                                    {% if doc.uploader == user and user.profile.is_uploader %}
                                    <a href="{% url 'document_delete' doc.pk %}" 
                                       class="btn btn-outline-danger btn-sm">
                                        <i class="fas fa-trash-alt me-1"></i>Delete
                                    </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="doc-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="badge {% if doc.document_type == 'scanned' %}bg-info{% else %}bg-secondary{% endif %} me-2">
                                        {{ doc.get_document_type_display }}
                                    </span>
                                    {% if doc.is_processed %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check-circle me-1"></i>Processed
                                        </span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="alert alert-info mt-3">
                <i class="fas fa-info-circle me-2"></i>
                No documents found. Upload some documents to start searching!
            </div>
        {% endif %}
    {% else %}
        <div class="alert alert-danger mt-4">
            <i class="fas fa-lock me-2"></i>
            You do not have permission to view this content.
        </div>
    {% endif %}
</div>
{% endblock content %}