{% extends 'base.html' %} 

{% block content %}
    
    <h1 class="display-6 text-primary mb-4">Semantic Search Engine</h1>

    {% if user.profile.is_searcher %}
        <form method="GET" action="{% url 'document_list' %}" class="mb-4">
            <input type="text" name="q" 
                   placeholder="Ask a question about the documents..." 
                   class="form-control form-control-lg d-inline-block w-75 me-2">
            <button type="submit" class="btn btn-primary btn-lg">Search</button>
        </form>

        {% if rag_results_by_doc %}
            <h2 class="mt-4">Semantic Search Results (RAG)</h2>
            <p class="lead text-muted">Showing relevant passages for your query: "<strong>{{ search_query }}</strong>"</p>
            
            {% for doc_title, chunks in rag_results_by_doc.items %}
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white">
                        <i class="fas fa-file-alt me-2"></i> Document: {{ doc_title }} 
                    </div>
                    <ul class="list-group list-group-flush">
                        {% for chunk in chunks %}
                            <li class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <small class="text-secondary">
                                        Page: <span class="badge bg-info text-dark me-2">{{ chunk.page }}</span>
                                        Type: <span class="badge bg-light text-secondary me-2">{{ chunk.type }}</span>
                                    </small>
                                    <small class="text-danger" title="Semantic Distance (Closer to 0 is better)">
                                        Distance: {{ chunk.distance|floatformat:4 }} 
                                    </small>
                                </div>
                                
                                <div class="p-2 border border-start-0 border-end-0 border-primary-subtle bg-light-subtle rounded">
                                    {{ chunk.content }}
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            {% endfor %}
        {% elif search_query %}
            <div class="alert alert-warning mt-4">
                Semantic search executed, but no relevant content was found for "<strong>{{ search_query }}</strong>".
            </div>
        {% endif %}
        
        {% if rag_error %}
        <p style="color: red; border: 1px solid red; padding: 10px;">
            **RAG Search Error:** {{ rag_error }}
        </p>
        {% endif %}
        <hr>

        {% if documents %}
        <h2>Available Documents (Total: {{ documents.count }})</h2>
        <p class="text-muted small">The list below shows documents processed and available for search.</p>
            <ul>
                {% for doc in documents %}
                    <li>
                        <strong>Title:</strong> {{ doc.title }} 
                        <small>| Uploaded by: {{ doc.uploader.username }}</small>
                        <p>Processed: {% if doc.is_processed %}✅{% else %}❌{% endif %}</p>

                        {% if doc.uploader == user %}
                            {% if not doc.is_processed %}
                                <p>
                                    <a href="{% url 'document_process' doc.pk %}">
                                        ▶️ Process Document
                                    </a>
                                </p>
                            {% else %}
                                <p>Output Snippet: {{ doc.processing_output|truncatechars:50 }}</p>
                            {% endif %}
                        {% endif %}
                        
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>No documents found matching your criteria, or no documents have been uploaded yet.</p>
        {% endif %}
        
    {% else %}
        <p>You do not have permission to view this content.</p>
    {% endif %}

{% endblock content %}