{% extends 'base.html' %} 

{% block content %}
    
    <h1>Document Search and List</h1>

    {% if user.profile.is_searcher %}
        <form method="GET" action="{% url 'document_list' %}">
            <input type="text" name="q" placeholder="Search by document title...">
            <button type="submit">Search</button>
        </form>

        {% if rag_results %}
            <h2>Semantic Search Results (RAG)</h2>
            <div style="border: 1px solid #ccc; padding: 15px; margin-bottom: 20px;">
                {% for chunk in rag_results %}
                    <div style="margin-bottom: 10px; border-bottom: 1px dashed #eee;">
                        <strong>Source:</strong> {{ chunk.document_title }} (Page: {{ chunk.page }})<br>
                        <small>Type: {{ chunk.type }} | Distance: {{ chunk.distance|floatformat:4 }}</small>
                        <p style="margin-top: 5px; background-color: #f9f9f9; padding: 5px; border-left: 3px solid purple;">
                            {{ chunk.content }}
                        </p>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
        
        {% if rag_error %}
        <p style="color: red; border: 1px solid red; padding: 10px;">
            **RAG Search Error:** {{ rag_error }}
        </p>
        {% endif %}
        <hr>

        {% if documents %}
            <h2>Results (Total: {{ documents.count }})</h2>
            <ul>
                {% for doc in documents %}
                    <li>
                        <strong>Title:</strong> {{ doc.title }} 
                        <small>| Uploaded by: {{ doc.uploader.username }}</small>
                        <p>Processed: {% if doc.is_processed %}✅{% else %}❌{% endif %}</p>

                        {% if doc.uploader == user %}
                            {% if not doc.is_processed %}
                                <p>
                                    <a href="{% url 'document_process' doc.pk %}">
                                        ▶️ Process Document
                                    </a>
                                </p>
                            {% else %}
                                <p>Output Snippet: {{ doc.processing_output|truncatechars:50 }}</p>
                            {% endif %}
                        {% endif %}
                        
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>No documents found matching your criteria, or no documents have been uploaded yet.</p>
        {% endif %}
        
    {% else %}
        <p>You do not have permission to view this content.</p>
    {% endif %}

{% endblock content %}